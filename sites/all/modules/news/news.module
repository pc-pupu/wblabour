<?php
function news_permission() {
  return array(
    'cmsnews_per' => array(
      'title' => t('cms news add/edit permission'),
    ),
	'news_per' => array(
      'title' => t('news list permission'),
    )
  );
}

function news_menu(){ 
 $items['news'] = array(
	'title' => 'News List',
	'page callback' => 'news_list',
	//'page arguments' => array('news_list'),
	'access arguments' => array('news_per'),
  );
  $items['cmsentry/cmsnews'] = array(
	'title' => 'CMS News List',
	'page callback' => 'drupal_get_form',
	'page arguments' => array('cmsnews_list'),
	'access arguments' => array('cmsnews_per'),
  );	 
  $items['cmsentry/cmsnews/addcmsnews'] = array(
	'title' => 'CMS News Entry',
	'page callback' => 'drupal_get_form',
	'page arguments' => array('add_news'),
	'access arguments' => array('cmsnews_per'),
  );
  $items['cmsentry/cmsnews/%/cmsnewsedit'] = array(
	'title' => 'CMS News Edit',
	'page callback' => 'drupal_get_form',
	'page arguments' => array('edit_news',2),
	'access arguments' => array('cmsnews_per'),
  );
  $items['daily-session'] = array(
	'page callback' => 'drupal_get_form',
	'page arguments' => array('daily_session'),
	'access arguments' => array('news_per'),
	'file' => 'include/daily_session.inc',
  );
    $items['cmsentry/news/download/%'] = array(
    'title' => 'Download News File',
    'page callback' => 'news_file_download_callback',
    'page arguments' => array(3),
    'access arguments' => array('cmsnews_per'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

function news_file_download_callback($filename) {
  $safe_filename = basename($filename);
  $uri = 'public://upload/news/' . $safe_filename;

  if (file_exists(drupal_realpath($uri))) {
    $filepath = drupal_realpath($uri);
    $mime_type = file_get_mimetype($filepath);

    header('Content-Type: application/octet-stream');
    header('Content-Disposition: attachment; filename="' . $safe_filename . '"');
    header('Content-Length: ' . filesize($filepath));
    readfile($filepath);
    exit;
  } else {
    drupal_set_message(t('File not found.'), 'error');
    drupal_goto('cmsentry/cmsnews');
  }
}


function news_list(){
	 global $base_root, $base_path;
	 $sort = 'DESC';
	 $order = 'newsdate';
     $cms_news_query = db_select('cms_news', 't');
     $cms_news_query->fields('t', array('newsid','newsdesc','newsdate','newsfile'));
	 $cms_news_query = $cms_news_query->extend('TableSort')->extend('PagerDefault')->limit(20);
	 $cms_news_query->orderBy($order, $sort);
	 $cms_news_query_result = $cms_news_query->execute();
	 $cms_news_query_result_data = $cms_news_query_result->fetchAll();
	 
	 $rows = array();
     $header = array();
  	 $output = '';
  
     $header = array(
          array('data' => 'News SL.NO'),
		  array('data' => 'News DATE'),
          array('data' => 'News DESCRIPTION'),
		  array('data' => 'FILE'),
      );
	 $i=0;
	 foreach($cms_news_query_result_data as $data){
		$i++;
		$aa=$base_root.$base_path.'sites/default/files/upload/news/'.$data->newsfile;
		$link_s=l(t('Download'), $aa, array('attributes' => array('target'=>'_blank'))) ;
		$rows[] = array(
      				$i,
					date('d-m-Y', strtotime($data->newsdate)),
      				$data->newsdesc,
					$link_s
	  	);   
	 }
	 
      				
	 
	 $output = theme_table(
    array(
      'header' => $header,
      'rows' => $rows,
      'attributes' => array('class' => array('table', 'table-bordered')),
      'sticky' => true,
      'caption' => '',
      'colgroups' => array(),
      'empty' => t("No data found!") // The message to be displayed if table is empty
    )
  ).theme('pager');

  	 
    return '<div class="table-responsive statistics_box">'.$output.'</div>';
}

function cmsnews_list($form, &$form_state){
	
	$form['add_news'] = array(
	  '#type' => 'markup',
	  '#markup' => l('Add News','cmsentry/cmsnews/addcmsnews'),
    );	
	
	$form['news_list_details'] = array(
	  '#type' => 'markup',
	  '#markup' => get_news_list(),
    );	
	return $form;
}
function get_news_list(){
	 global $base_root, $base_path;
	 $sort = 'DESC';
	 $order = 'newsdate';
     $cms_news_query = db_select('cms_news', 't');
     $cms_news_query->fields('t', array('newsid','newsdesc','newsdate'));
	 $cms_news_query = $cms_news_query->extend('TableSort')->extend('PagerDefault')->limit(20);
	 $cms_news_query->orderBy($order, $sort);
	 $cms_news_query_result = $cms_news_query->execute();
	 $cms_news_query_result_data = $cms_news_query_result->fetchAll();
	 
	 $rows = array();
     $header = array();
  	 $output = '';
  
     $header = array(
          array('data'=> 'News SL.NO'),
		  array('data'=> 'News DATE'),
          array('data' => 'News DESCRIPTION'),
		  array('data' => 'News VIEW/EDIT'),
      );
	 $i=0;
	 foreach($cms_news_query_result_data as $data){
		$i++;
		$aa=$base_root.$base_path.'cmsentry/cmsnews/'.$data->newsid.'/cmsnewsedit';
		$link_s=l(t('View/Edit'), $aa) ;
		$rows[] = array(
      				$i,
					date('d-m-Y', strtotime($data->newsdate)),
      				$data->newsdesc,
					$link_s
	  	);   
	 }
	 
      				
	 
	 $output = theme_table(
    array(
      'header' => $header,
      'rows' => $rows,
      'attributes' => array('class' => array('table', 'table-bordered')),
      'sticky' => true,
      'caption' => '',
      'colgroups' => array(),
      'empty' => t("No data found!") // The message to be displayed if table is empty
    )
  ).theme('pager');

  	 
    return '<div class="table-responsive statistics_box">'.$output.'</div>';
}

function add_news($form, &$form_state){
   global $base_root, $base_path;
	 
   $form['add_news_date'] = array(
	 '#title'=> 'News Date :',
	 '#type' => 'date',
     '#default_value' => array(
         'month' => format_date(time(), 'custom', 'n'),
         'day' => format_date(time(), 'custom', 'j'),
         'year' => format_date(time(), 'custom', 'Y'),
       ),
	 '#required' => TRUE,
	 );  
		 
	$form['add_news_desc'] = array(
	   '#title'=>'News Description :',
	   '#cols' => 20, 
       '#rows' => 4,
	   '#type' => 'textarea',
	   '#element_validate' => array('news_textfield_validate'),
	   '#required' => TRUE,
	);
		 
    $form['add_news_pdf'] = array(
	   '#title' => t('Upload a Scanned file of the News (JPG,PDF only)'),
	   '#type' => 'managed_file',
	   '#upload_validators' => array('file_validate_extensions' => array('pdf jpg'), 'file_validate_size' => array(10*1024*1024)),
	   '#upload_location' => 'public://upload/news/',
	   '#process' => array('import_my_file_element_process'),
	   '#required' => TRUE,
	);
	
    $form['submit'] = array (
        '#type' => 'submit',
        '#value' => 'Save',
		'#prefix' => '<div align="center">',  
        '#suffix' => '</div>',
     ); 
	  
	return  $form;
	 
 }

 function add_news_validate($form, &$form_state) {
  $fid = $form_state['values']['add_news_pdf'];

  if (is_array($fid)) {
    $fid = reset($fid); // Get the actual FID
  }

  if ($fid) {
    $file = file_load($fid);
    if ($file) {
      $filename = $file->filename;
      $filepath = drupal_realpath($file->uri);

      // 1. Check for double extensions like .exe.pdf
      if (preg_match('/\.[^\.]+\.[^\.]+$/', $filename)) {
        file_delete($file);
        form_set_error('add_news_pdf', t('Double extension files are not allowed. Only JPG or PDF files are permitted.'));
        $form_state['rebuild'] = TRUE;
        return;
      }

      // 2. Detect actual MIME type
      if (function_exists('finfo_open')) {
        $finfo = finfo_open(FILEINFO_MIME_TYPE);
        $mime = finfo_file($finfo, $filepath);
        finfo_close($finfo);
      } else {
        $mime = mime_content_type($filepath); // fallback
      }

      // 3. Allow only actual PDF or JPG MIME types
      $allowed_mime = ['application/pdf', 'image/jpeg'];
      if (!in_array($mime, $allowed_mime)) {
        file_delete($file);
        form_set_error('add_news_pdf', t('Invalid file content (%mime). Only valid PDF or JPG files are allowed.', ['%mime' => $mime]));
        $form_state['rebuild'] = TRUE;
        return;
      }
    }
  }
}

 
function add_news_submit($form, &$form_state){ 
	$arr = array();
	$newsPdf = "";
	
	$news_desc=check_plain($form_state['values']['add_news_desc']);
	$news_date=$form_state['values']['add_news_date']['year'].'-'.$form_state['values']['add_news_date']['month'].'-'.$form_state['values']['add_news_date']['day']; 

	$news_doc = file_load($form_state['values']['add_news_pdf']);
	if(!empty($news_doc)){
		$arr = explode("/", $news_doc->uri);
		$news_doc->status = FILE_STATUS_PERMANENT;
		file_save($news_doc);
		$newsPdf = $arr[4];
	 }
	
	$newsInfo = array('newsdate'=>$news_date,
						'newsdesc'=>$news_desc,
						'newsfile' => $newsPdf);
						
	$id = db_insert('cms_news')->fields($newsInfo)->execute();
	drupal_set_message('Your Record has been inserted successfully.');

}


function edit_news($form, &$form_state, $args=''){
   global $base_root, $base_path;
   
   $cms_news_query = db_select('cms_news', 't');
   $cms_news_query->fields('t', array('newsid','newsdesc','newsdate','newsfile'));	
   $cms_news_query->condition('t.newsid',trim($args),'=');
   $qry_data = $cms_news_query->execute();
   $result = $qry_data->fetchAssoc();
   
   if($result['newsdate']!=""){
	   	$cdate = explode("-", $result['newsdate']);
		
		$cdate[1]= ltrim($cdate[1], '0'); 
		$cdate[2]= ltrim($cdate[2], '0');  
		$form['edit_news_date'] = array(
		 '#title'=>' news Date :',
		 '#type' => 'date',
		 '#default_value' => array(
			 'month' => format_date(time(), 'custom', $cdate['1']),
			 'day' => format_date(time(), 'custom', $cdate['2']),
			 'year' => format_date(time(), 'custom', $cdate['0']),
		   ),
		 '#required' => TRUE,
		 );   
   }else{
	   $form['edit_news_date'] = array(
		 '#title'=>'News Date :',
		 '#type' => 'date',
		 '#default_value' => array(
			 'month' => format_date(time(), 'custom', 'n'),
			 'day' => format_date(time(), 'custom', 'j'),
			 'year' => format_date(time(), 'custom', 'Y'),
		   ),
		 '#required' => TRUE,
		 );  
   }
		 
	$form['edit_news_desc'] = array(
	   '#title'=>'News Description :',
	   '#cols' => 20, 
       '#rows' => 4,
	   '#type' => 'textarea',
	   '#default_value' =>trim($result['newsdesc']),
	   '#element_validate' => array('news_textfield_validate'),
	   '#required' => TRUE,
	);
	
	$uri = 'public://upload/news/' . trim($result['newsfile']);

	if (file_exists(drupal_realpath($uri))) {
	  $download_link = url('cmsentry/news/download/' . trim($result['newsfile']), array('absolute' => TRUE));
	  $img_html = '<img src="' . $GLOBALS['base_url'] . '/' . drupal_get_path('theme', 'labourdept') . '/images/pdf.png" alt="Download PDF">';

	  $form['news_file_up'] = array(
	    '#markup' => l($img_html, $download_link, array(
	      'html' => TRUE,
	      'attributes' => array('class' => array('pdfloc1'))
	    )),
	  );
	}
	else{
		$form['news_file_up'] = array(
        '#markup' => t('No File Exist'),
		'#prefix' => '<div class="pdfnone">',
	    '#suffix' => '</div>'
        );
	}
		 
    $form['edit_news_pdf'] = array(
	   '#title' => t('Upload a Scanned file of the News (JPG,PDF only)'),
	   '#type' => 'managed_file',
	   '#upload_validators' => array('file_validate_extensions' => array('pdf jpg'), 'file_validate_size' => array(10*1024*1024)),
	   '#upload_location' => 'public://upload/news/',
	   '#process' => array('import_my_file_element_process'),
	   //'#required' => TRUE,
	);
	$form['news_id'] = array(
		'#title' => t('News Id'),
		'#type' => 'hidden',
		'#default_value' => isset($args) ? $args : NULL,
	);	
    $form['submit'] = array (
        '#type' => 'submit',
        '#value' => 'Save',
		'#prefix' => '<div align="center">',  
        '#suffix' => '</div>',
     ); 
	  
	return  $form;
	 
 } 

 function edit_news_validate($form, &$form_state) {
  $fid = $form_state['values']['edit_news_pdf'];

  if (is_array($fid)) {
    $fid = reset($fid); // Get the actual FID
  }

  if ($fid) {
    $file = file_load($fid);
    if ($file) {
      $filename = $file->filename;
      $filepath = drupal_realpath($file->uri);

      // 1. Check for double extensions like .exe.pdf
      if (preg_match('/\.[^\.]+\.[^\.]+$/', $filename)) {
        file_delete($file);
        form_set_error('edit_news_pdf', t('Double extension files are not allowed. Only JPG or PDF files are permitted.'));
        $form_state['rebuild'] = TRUE;
        return;
      }

      // 2. Detect actual MIME type using finfo (or fallback)
      if (function_exists('finfo_open')) {
        $finfo = finfo_open(FILEINFO_MIME_TYPE);
        $mime = finfo_file($finfo, $filepath);
        finfo_close($finfo);
      } else {
        $mime = mime_content_type($filepath); // Fallback for older PHP
      }

      // 3. Allow only real PDF or JPG
      $allowed_mime = ['application/pdf', 'image/jpeg'];
      if (!in_array($mime, $allowed_mime)) {
        file_delete($file);
        form_set_error('edit_news_pdf', t('Invalid file content (%mime). Only valid PDF or JPG files are allowed.', ['%mime' => $mime]));
        $form_state['rebuild'] = TRUE;
        return;
      }
    }
  }
}

 
function edit_news_submit($form, &$form_state){ 
	$arr = array();
	$newsPdf = "";
	
	$news_desc=check_plain($form_state['values']['edit_news_desc']);
	$news_date=$form_state['values']['edit_news_date']['year'].'-'.$form_state['values']['edit_news_date']['month'].'-'.$form_state['values']['edit_news_date']['day']; 

	$news_doc = file_load($form_state['values']['edit_news_pdf']);
	if(!empty($news_doc)){
		$arr = explode("/", $news_doc->uri);
		$news_doc->status = FILE_STATUS_PERMANENT;
		file_save($news_doc);
		$newsPdf = $arr[4];
	 }else{
		$file_name=$form_state['values']['scan_file'];
		$newsPdf = $file_name;
	}
	
	$newsInfo = array('newsdate'=>$news_date,
						'newsdesc'=>$news_desc,
						'newsfile' => $newsPdf);
						
	$query = db_update('cms_news');
	$query->fields(array('newsdate' =>	$news_date,
						 'newsdesc' =>	$news_desc,
 						 'newsfile' =>	$newsPdf));
	$query->condition('newsid', $form_state['values']['news_id']);
	$rs = $query->execute();
	if($rs){
		drupal_set_message("Your data has been updated successfully");
		drupal_goto('cmsentry/cmsnews');
	}

} 

 
function news_textfield_validate($element, &$form_state) {
   if(trim($element['#value']))
   {
        $val="a".trim($element['#value']);
		if(stripos($val,"~") >0  || stripos($val,"!") >0 || stripos($val,"@")>0 || stripos($val,"<")>0 || stripos($val,">")>0 || stripos($val,"'")>0 || stripos($val,"$")>0 || stripos($val,"#")>0 || stripos($val,"%")>0 || stripos($val,"^")>0  || stripos($val,"*")>0){
       form_error($element, t($element['#title'].'  contain illegal character .'));
	   }
   }
}

